<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.io.mapper.BoardMapper">

	<select id="selectAllBoard" resultType="com.io.model.BoardDTO">
		select  b.*, ui.uname, d.did, d.dname 
		from userinfo ui join dept d 
		on ui.did = d.did
		join board b on b.uemail = ui.uemail
		order by b.regdate desc
	
	</select>
	
	 <select id="selectAllTempBoard" resultType="com.io.model.TboardDTO">
        select b.*, ui.uname, d.did, d.dname 
        from userinfo ui 
        join dept d on ui.did = d.did
        join tboard b on b.uemail = ui.uemail
        <where>
            <if test="code != null">
                and b.code = #{code}
            </if>
        </where>
        order by b.tmpregdate desc
    </select>
    
    
<insert id="insertBoards" parameterType="java.util.List">
    INSERT INTO board (bno, title, bcontent, uemail, regdate, caid)
    SELECT board_seq.nextval, A.title, A.tmpcontent, A.uemail, A.systimestamp, A.caid
    FROM (
        <foreach collection="list" item="item" separator=" UNION ALL ">
            SELECT 
                #{item.tmptitle} as title, 
                #{item.tmpcontent} as tmpcontent,
                #{item.uemail} as uemail,
                current_timestamp as systimestamp,
                #{item.caid} as caid 
            FROM DUAL
        </foreach>
    ) A
</insert>
	
	<update id="updateBoardCode" parameterType="com.io.model.TboardDTO">
		update tboard set code= #{code} where tno= #{tno}
	
	</update>
	
	
	<insert id="updatePermitToComplete" parameterType="java.util.List">
      	update tboard set code = 'complete' where code = 'permit'
	</insert>
	
	
	 <resultMap id="codeCountMap" type="map">
        <result property="code" column="code"/>
        <result property="count" column="count"/>
    </resultMap>

    <select id="selectCodeCount" resultMap="codeCountMap">
        SELECT code, COUNT(*) AS count
        FROM tboard
        GROUP BY code
    </select>
    
    <select id="selectUserList" resultType="com.io.model.BoardDTO">
    SELECT ui.uemail as umeil, ui.uname as uname, de.dname as dname, count(b.uemail) AS post_count
	FROM userinfo ui
	JOIN dept de ON ui.did = de.did
	LEFT JOIN board b ON ui.uemail = b.uemail
	GROUP BY ui.uemail, ui.uname, de.dname
    </select>
	



    
	
	
  
  
  
</mapper>